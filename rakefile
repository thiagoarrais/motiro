require 'fileutils'
require 'rake/testtask'

SITE_DIR = File.dirname(__FILE__)

include FileTest

def cp_ru(src, dest)
    if directory?(src) then
        mkdir_p dest
        Dir.foreach(src) do |file|
            unless file == '.' || file == '..'
                cp_ru "#{src}/#{file}", "#{dest}/#{file}"
            end
        end
    elsif File.stat(src).file? then
        unless uptodate?(dest, src)
            if !exists?(dest) || writable?(dest)
                copy_file(src, dest)
            end
        end
    end
end

def copy_source
    builddir = "#{SITE_DIR}/build"
    mkdir_p builddir
    cp_ru "#{SITE_DIR}/src", "#{builddir}"
end

def rails_generate
    #the purpose of this ARGV black magic is to pass command
    #line arguments to the rails generate script
    ARGV.slice(0, ARGV.length - 1)
    ARGV.push('-s', File.expand_path("#{SITE_DIR}/build"))
    require_gem 'rails'
    load 'rails'
end

Rake::TestTask.new do |task|
    task.test_files = FileList["#{SITE_DIR}/src/test/unit/ts_all_suites.rb"]
    task.verbose = true
end

task :publish => :test do
     copy_source
     rails_generate
end

task :default => :publish

